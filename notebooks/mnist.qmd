```{julia}
include("notebooks/setup.jl")
eval(setup_notebooks)
```

# MNIST

```{julia}
# Data:
counterfactual_data = load_mnist()
X, y = CounterfactualExplanations.DataPreprocessing.unpack_data(counterfactual_data)
X = table(permutedims(X))
labels = counterfactual_data.output_encoder.labels
input_dim, n_obs = size(counterfactual_data.X)
```

```{julia}
epochs = 100
clf = NeuralNetworkClassifier(
    builder=MLJFlux.MLP(hidden=(32,), σ=relu), 
    epochs=epochs,
    batch_size=Int(round(n_obs/10))
)
conf_model = conformal_model(clf; method=:simple_inductive)
mach = machine(conf_model, X, labels)
fit!(mach)
```

```{julia}
M = CCE.ConformalModel(mach.model, mach.fitresult)
```

```{julia}
test_data = load_mnist_test()
f1 = CounterfactualExplanations.Models.model_evaluation(M, test_data)
println("F1 score (test): $(round(f1,digits=3))")
```

```{julia}
using CounterfactualExplanations.DataPreprocessing: undersample
dt_reduced = undersample(counterfactual_data, 100)
# dt_reduced = counterfactual_data
```

```{julia}
# Set up search:
factual_label = 9
x = reshape(counterfactual_data.X[:,rand(findall(predict_label(M, counterfactual_data).==factual_label))],input_dim,1)
target = 4
factual = predict_label(M, counterfactual_data, x)[1]
γ = 0.9
T = 100

# Generate counterfactual using generic generator:
generator = GenericGenerator()
ce_wachter = generate_counterfactual(
    x, target, dt_reduced, M, generator; 
    decision_threshold=γ, max_iter=T,
    initialization=:identity,
)

# Generate counterfactual using CCE generator:
generator = CCEGenerator(
    λ=[0.0,10.0], 
    temp=0.01, 
    # opt=CounterfactualExplanations.Generators.JSMADescent(η=5.0),
)
ce_conformal = generate_counterfactual(
    x, target, dt_reduced, M, generator; 
    decision_threshold=γ, max_iter=T,
    initialization=:identity,
    converge_when=:generator_conditions,
)
```

```{julia}
p1 = Plots.plot(
    convert2image(MNIST, reshape(x,28,28)),
    axis=nothing, 
    size=(img_height, img_height),
    title="Factual"
)
plts = [p1]

ces = zip([ce_wachter,ce_conformal])
counterfactuals = reduce((x,y)->cat(x,y,dims=3),map(ce -> CounterfactualExplanations.counterfactual(ce[1]), ces))
phat = reduce((x,y) -> cat(x,y,dims=3), map(ce -> target_probs(ce[1]), ces))
for x in zip(eachslice(counterfactuals; dims=3), eachslice(phat; dims=3))
    ce, _phat = (x[1],x[2])
    _title = "p(y=$(target)|x′)=$(round(_phat[1]; digits=3))"
    plt = Plots.plot(
        convert2image(MNIST, reshape(ce,28,28)),
        axis=nothing, 
        size=(img_height, img_height),
        title=_title
    )
    plts = [plts..., plt]
end
plt = Plots.plot(plts...; size=(img_height*length(plts),img_height), layout=(1,length(plts)))
display(plt)
savefig(plt, joinpath(www_path, "cce_mnist.png"))
```